<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kirby Tsum Tsum Game</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.24.1/dist/phaser.min.js"></script>
    <style>
      body {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <script>
      const config = {
        type: Phaser.AUTO,
        width: 7 * 55,
        height: 4 * 55,
        backgroundColor: "transparent",
        pixelArt: true,
        physics: {
          default: "matter",
          matter: {
            gravity: { y: 1 },
            debug: false,
          },
        },
        scene: {
          preload: preload,
          create: create,
          update: update,
        },
      };

      const game = new Phaser.Game(config);
      let selectedTsums = [];

      function preload() {
        this.load.image("A", "./kirby.png");
        this.load.image("B", "./bronto.png");
        this.load.image("C", "./waddledoo.png");
        this.load.image("D", "./waddledee.png");

        this.load.audio("selectTsumSound", "./text.m4a");
        this.load.audio("clearTsumsSound", "./fly-spit.m4a");
      }

      function create() {
        this.selectTsumSound = this.sound.add("selectTsumSound");
        this.clearTsumsSound = this.sound.add("clearTsumsSound");

        const tsumTypes = ["A", "B", "C", "D"];
        this.tsums = [];

        // Create tsums and add them to the scene
        for (let i = 0; i < config.width / 55; i++) {
          for (let j = 0; j < config.height / 55; j++) {
            const randomType = Phaser.Utils.Array.GetRandom(tsumTypes);
            const tsum = this.add.sprite(
              i * 55 + 27.5,
              j * 55 + 27.5,
              randomType
            );
            tsum.setInteractive();
            tsum.on("pointerdown", (pointer) => {
              //   this.selectTsumSound.play();
              handleTsumSelection(tsum, this);
            });
            this.tsums.push(tsum);
          }
        }
      }

      function update() {
        // Add any continuous checks or updates here
      }

      function handleTsumSelection(tsum, scene) {
        if (
          selectedTsums.length === 0 ||
          selectedTsums[selectedTsums.length - 1].texture.key ===
            tsum.texture.key
        ) {
          tsum.setTint(0x999999);
          selectedTsums.push(tsum);
        } else if (
          selectedTsums.length >= 2 &&
          selectedTsums[selectedTsums.length - 2] === tsum
        ) {
          const lastTsum = selectedTsums.pop();
          lastTsum.clearTint();
        } else {
          clearSelectedTsums(scene);
        }
      }

      function clearSelectedTsums(scene) {
        if (selectedTsums.length >= 3) {
          selectedTsums.forEach((tsum) => {
            scene.tweens.add({
              targets: tsum,
              alpha: 0,
              duration: 500,
              onComplete: () => {
                tsum.destroy();
              },
            });
          });
          //   scene.clearTsumsSound.play();
        } else {
          selectedTsums.forEach((tsum) => {
            tsum.clearTint();
          });
        }
        selectedTsums = [];
      }
    </script>
  </body>
</html>
